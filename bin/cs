#!/usr/bin/env bash
# ABOUTME: Claude Code session manager with artifact tracking and tmux integration
# ABOUTME: Creates isolated session workspaces with automatic documentation and file organization

set -euo pipefail

# Configuration
SESSIONS_ROOT="$HOME/.claude-sessions"
CLAUDE_CODE_BIN="${CLAUDE_CODE_BIN:-claude}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Utility functions
error() {
    echo -e "${RED}Error: $1${NC}" >&2
    exit 1
}

info() {
    echo -e "${GREEN}$1${NC}"
}

warn() {
    echo -e "${YELLOW}$1${NC}"
}

# Check dependencies
check_dependencies() {
    local missing=()

    command -v "$CLAUDE_CODE_BIN" >/dev/null 2>&1 || missing+=("claude-code")

    if [ ${#missing[@]} -gt 0 ]; then
        error "Missing required dependencies: ${missing[*]}"
    fi
}

# Validate session name
validate_session_name() {
    local name="$1"

    if [ -z "$name" ]; then
        error "Session name cannot be empty"
    fi

    if ! [[ "$name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        error "Session name must contain only alphanumeric characters, hyphens, and underscores"
    fi
}

# Create session directory structure
create_session_structure() {
    local session_dir="$1"

    mkdir -p "$session_dir"/{artifacts,logs}

    # Create README.md
    cat > "$session_dir/README.md" << EOF
# Session: $(basename "$session_dir")

**Started:** $(date '+%Y-%m-%d %H:%M:%S')
**Location:** $(hostname):$(pwd)

## Objective

[Describe what you're trying to accomplish in this session]

## Environment

[Describe the system, server, or context you're working in]

## Outcome

[To be filled when session is complete - summarize what was accomplished]
EOF

    # Create discoveries.md
    cat > "$session_dir/discoveries.md" << 'EOF'
# Discoveries

Document what you learn about the environment, system, or codebase:

- System architecture and configuration
- Existing patterns and conventions
- Dependencies and relationships
- Unexpected behaviors or gotchas
- Useful commands or procedures

Update this file as you discover new information throughout the session.
EOF

    # Create changes.md
    cat > "$session_dir/changes.md" << 'EOF'
# Changes Made

Document all modifications, fixes, and changes made during this session:

## Files Modified

-

## Configuration Changes

-

## Bug Fixes

-

## Scripts Created

-

Update this file as you make changes throughout the session.
EOF

    # Create notes.md
    cat > "$session_dir/notes.md" << 'EOF'
# Session Notes

Miscellaneous observations, ideas, and context that don't fit in other files.

Use this as a scratchpad for thoughts and temporary notes.
EOF

    # Create CLAUDE.md with session-specific instructions
    cat > "$session_dir/CLAUDE.md" << 'EOF'
# Session Documentation Protocol

This is a Claude Code session managed by the cs tool. This session has automatic artifact tracking and documentation support.

## Session Structure

This session directory contains:

- **README.md** - Session overview, objective, environment, and outcome
- **discoveries.md** - Document findings about the system/environment
- **changes.md** - Log all modifications and fixes made
- **notes.md** - Miscellaneous observations and ideas
- **artifacts/** - Automatically collected scripts and configuration files
- **logs/session.log** - Complete session command log

## Artifact Auto-Tracking

Scripts and configuration files you create are **automatically saved to artifacts/**:

- Scripts: .sh, .bash, .zsh, .py, .js, .ts, .rb, .pl
- Configs: .conf, .config, .json, .yaml, .yml, .toml, .ini, .env

When you use the Write tool for these file types, they are automatically redirected to the artifacts/ directory and tracked in MANIFEST.json.

## Documentation Discipline

**IMPORTANT:** Update the markdown documentation files throughout the session:

1. **Start of session:** Fill in README.md objective and environment
2. **As you work:** Update discoveries.md with findings and changes.md with modifications
3. **End of session:** Complete the README.md outcome section

Treat these files as a lab notebook - document as you go, not just at the end.

## Tmux Integration

If you need tmux functionality during this session, use the tmux skill available in Claude Code.

## Summary Command

When the session is complete, use the `/summary` command to generate an intelligent summary of the entire session. This will create a summary.md file synthesizing all documentation.

## SSH Workflow

For remote server work:
1. Establish SSH connection in the main pane: `ssh user@host`
2. Run commands on the remote system as needed
3. Session documentation remains local
4. Artifacts are saved locally

## Best Practices

- Document discoveries as you find them - don't wait until the end
- Use artifacts/ for any reusable scripts or configs
- Keep changes.md updated with each modification
- Use notes.md for temporary thoughts and ideas
- Run `/summary` at the end to create a cohesive record
EOF

    # Initialize empty MANIFEST.json
    echo "[]" > "$session_dir/artifacts/MANIFEST.json"

    # Initialize session log
    cat > "$session_dir/logs/session.log" << EOF
Claude Code Session Log
Session: $(basename "$session_dir")
Started: $(date '+%Y-%m-%d %H:%M:%S')
Location: $(hostname):$(pwd)

================================================================================

EOF
}

# Launch Claude Code
launch_claude_code() {
    local session_name="$1"
    local session_dir="$2"

    # Set environment variables
    export CLAUDE_SESSION_NAME="$session_name"
    export CLAUDE_SESSION_DIR="$session_dir"
    export CLAUDE_ARTIFACT_DIR="$session_dir/artifacts"

    # Launch Claude Code
    info "Launching Claude Code in session: $session_name"
    info "Session directory: $session_dir"
    info ""

    cd "$session_dir"
    exec "$CLAUDE_CODE_BIN"
}

# Main function
main() {
    if [ $# -eq 0 ]; then
        error "Usage: cs <session-name>"
    fi

    local session_name="$1"

    # Validate inputs
    validate_session_name "$session_name"
    check_dependencies

    # Define paths
    local session_dir="$SESSIONS_ROOT/$session_name"

    # Create session structure if needed
    if [ ! -d "$session_dir" ]; then
        info "Creating new session: $session_name"
        create_session_structure "$session_dir"
    else
        info "Resuming existing session: $session_name"
    fi

    # Launch Claude Code
    launch_claude_code "$session_name" "$session_dir"
}

main "$@"
