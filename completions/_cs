#compdef cs
# ABOUTME: Zsh completion script for cs (Claude Code session manager)
# ABOUTME: Provides tab-completion for session names, commands, and subcommands

_cs() {
    local curcontext="$curcontext" state line
    typeset -A opt_args

    local sessions_root="${CS_SESSIONS_ROOT:-$HOME/.claude-sessions}"

    # Helper: get session names
    _cs_sessions() {
        local -a sessions
        if [[ -d "$sessions_root" ]]; then
            sessions=("$sessions_root"/*(N/:t))
        fi
        compadd -a sessions
    }

    # Sync subcommands with descriptions
    local -a sync_cmds
    sync_cmds=(
        'init:Initialize git repo with remote URL'
        'push:Commit and push changes'
        'pull:Pull changes from remote'
        'status:Show sync status'
        'st:Show sync status (alias)'
        'auto:Toggle/show auto-sync setting'
        'clone:Clone session from remote'
    )

    # Secrets subcommands with descriptions
    local -a secrets_cmds
    secrets_cmds=(
        'set:Store a secret'
        'store:Store a secret (alias)'
        'get:Retrieve a secret value'
        'list:List all secrets'
        'ls:List all secrets (alias)'
        'delete:Delete a secret'
        'rm:Delete a secret (alias)'
        'purge:Delete ALL secrets'
        'export:Export as environment variables'
        'export-file:Export to encrypted file'
        'import-file:Import from encrypted file'
        'migrate:Migrate plaintext secrets'
        'backend:Show storage backend'
    )

    # Global flags with descriptions
    local -a global_flags
    global_flags=(
        '-list:List all sessions'
        '-ls:List all sessions (alias)'
        '-remove:Remove a session'
        '-rm:Remove a session (alias)'
        '-sync:Sync current session'
        '-s:Sync current session (alias)'
        '-secrets:Manage session secrets'
        '-update:Update cs to latest version'
        '-uninstall:Uninstall cs'
        '-help:Show help message'
        '-h:Show help message (alias)'
        '-version:Show version'
        '-v:Show version (alias)'
    )

    # Determine context
    local in_sync=false in_secrets=false has_session=false after_remove=false
    local i word

    for ((i=1; i < CURRENT; i++)); do
        word="${words[i+1]}"
        case "$word" in
            -sync|-s) in_sync=true; in_secrets=false ;;
            -secrets) in_secrets=true; in_sync=false ;;
            -remove|-rm) after_remove=true ;;
            -*) ;;
            *)
                if ! $in_sync && ! $in_secrets && ! $after_remove; then
                    has_session=true
                fi
                ;;
        esac
    done

    # Context: after -remove/-rm
    if $after_remove && [[ $CURRENT -eq 3 ]]; then
        _cs_sessions
        return
    fi

    # Context: after -sync/-s
    if $in_sync; then
        _describe 'sync command' sync_cmds
        return
    fi

    # Context: after -secrets
    if $in_secrets; then
        _describe 'secrets command' secrets_cmds
        return
    fi

    # Context: after session name
    if $has_session; then
        local -a session_opts
        session_opts=(
            '-sync:Run sync command'
            '-s:Run sync command (alias)'
            '-secrets:Run secrets command'
        )
        _describe 'option' session_opts
        return
    fi

    # First argument: session names and global flags
    if [[ $CURRENT -eq 2 ]]; then
        if [[ "$words[CURRENT]" == -* ]]; then
            _describe 'command' global_flags
        else
            _cs_sessions
        fi
        return
    fi

    return 1
}

_cs "$@"
